<?php

namespace Tualo\Office\MSGraphDOCX\Routes\Setup;

use Tualo\Office\Basic\TualoApplication as App;
use Tualo\Office\Basic\Route as BasicRoute;
use Tualo\Office\Basic\IRoute;
use Microsoft\Kiota\Abstractions\ApiException;

use Tualo\Office\MSGraph\API;
use Tualo\Office\MSGraph\api\MissedTokenException;
use GuzzleHttp\Exception\ClientException;
use GuzzleHttp\Exception\ServerException;

use Microsoft\Graph\Generated\Models;


use Microsoft\Graph\Generated\Users\Item\Messages\MessagesRequestBuilderGetRequestConfiguration;
use Microsoft\Graph\Generated\Applications\ApplicationsRequestBuilderGetRequestConfiguration;


class DriveItems extends \Tualo\Office\Basic\RouteWrapper
{
    public static function register()
    {

        /**
         * 
         * 
         * <?php
use Microsoft\Graph\Generated\Models;

// Neuen Ordner erstellen
$driveItem = new Models\DriveItem();
$driveItem->setName("Neuer Ordner");
$driveItem->setFolder(new Models\Folder());

// Im Root eines bestimmten Drives
$result = $graphServiceClient->drives()
    ->byDriveId($driveId)
    ->root()
    ->children()
    ->post($driveItem)
    ->wait();


<?php
$driveItem = new Models\DriveItem();
$driveItem->setName("neue-datei.txt");
$driveItem->setFile(new Models\File());

$result = $graphServiceClient->drives()
    ->byDriveId($driveId)
    ->root()
    ->children()
    ->post($driveItem)
    ->wait();


<?php
$result = $graphServiceClient->drives()
    ->byDriveId($driveId)
    ->items()
    ->byDriveItemId($parentFolderId)
    ->children()
    ->post($driveItem)
    ->wait();

    <?php
// Verfügbare Drives abrufen
$drives = $graphServiceClient->drives()->get()->wait();
$driveId = $drives->getValue()[0]->getId(); // Existierende DriveID verwenden

// Oder spezifisches Drive eines Benutzers
$userDrive = $graphServiceClient->users()
    ->byUserId($userId)
    ->drive()
    ->get()
    ->wait();
$driveId = $userDrive->getId();

// Dann DriveItems darin erstellen
$driveItem = new Models\DriveItem();
$driveItem->setName("Mein Ordner");
$driveItem->setFolder(new Models\Folder());

$result = $graphServiceClient->drives()
    ->byDriveId($driveId)
    ->root()
    ->children()
    ->post($driveItem)
    ->wait();
         */
        BasicRoute::add('/msgraph-docx/drives', function ($matches) {
            try {
                $graphServiceClient = API::GraphClient();
                $list = [];
                try {
                    $drives = $graphServiceClient->drives()->get()->wait();


                    if ($drives && $drives->getValue()) {
                        foreach ($drives->getValue() as $drive) {

                            $list[] = [
                                'id' => $drive->getId(),
                                'name' => $drive->getName(),
                                'type' => $drive->getDriveType(),
                                'description' => $drive->getDescription(),
                                'weburl' => $drive->getWebUrl()
                            ];
                        }
                    }
                    App::result('drives', $list);


                    $personal_list = [];
                    $personal_drives = $graphServiceClient->me()->drives()->get()->wait();


                    if ($personal_drives && $personal_drives->getValue()) {
                        foreach ($personal_drives->getValue() as $drive) {

                            $personal_list[] = [
                                'id' => $drive->getId(),
                                'name' => $drive->getName(),
                                'type' => $drive->getDriveType(),
                                'description' => $drive->getDescription(),
                                'weburl' => $drive->getWebUrl()
                            ];
                        }
                    }
                    App::result('personal_drives', $personal_list);

                    $teamDrives = [];
                    $teams = $graphServiceClient->me()->joinedTeams()->get()->wait();

                    foreach ($teams->getValue() as $team) {
                        // Das primäre Drive eines Teams
                        $drive = $graphServiceClient->groups()
                            ->byGroupId($team->getId())
                            ->drive()
                            ->get()
                            ->wait();
                        $teamDrives[] = [
                            'team_name' => $team->getDisplayName(),
                            'drive_id' => $drive->getId(),
                            'drive_weburl' => $drive->getWebUrl()
                        ];
                    }
                    App::result('team_drives', $teamDrives);
                } catch (ApiException $ex) {
                    App::result('drives', []);
                    App::result('drives_error', [
                        'code' => $ex->getResponseStatusCode(),
                        'message' => $ex->getError()->getMessage()
                    ]);
                }

                if (count($list) == 0) throw new \Exception('no drives found');

                App::result('success', true);
            } catch (\Exception $e) {
                App::result('error', $e->getMessage());
            }
            App::contenttype('application/json');
        }, ['get'], true);


        BasicRoute::add('/msgraph-docx/open/(?P<file_id>.+)', function ($matches) {
            try {
                $graphServiceClient = API::GraphClient();
                $db = App::get('session')->getDB();
                $files = $db->direct("select * from doc_binary where document_link = {id}", [
                    'id' => $matches['file_id']
                ]);
                $binaryData = $files[0]['doc_data'];

                $personal_drives = $graphServiceClient->me()->drives()->get()->wait();


                if ($personal_drives && $personal_drives->getValue()) {
                    $useDriveID = $personal_drives->getValue()[0]->getId();
                    $fileName = $matches['file_id'] . ".docx";

                    // Stream erstellen für den Upload
                    $stream = \GuzzleHttp\Psr7\Utils::streamFor($binaryData);

                    // Datei direkt hochladen (für Dateien < 4MB)
                    $result = $graphServiceClient->drives()
                        ->byDriveId($useDriveID)
                        ->items()
                        ->byDriveItemId('root:/' . $fileName . ':')
                        ->content()
                        ->put($stream)
                        ->wait();

                    App::result('result', $result);

                    $itemId = $result->getId();
                    $webUrl = $result->getWebUrl();  // URL zum Öffnen im Browser
                    $name = $result->getName();
                    $size = $result->getSize();
                    $eTag = $result->getETag();
                    $createdDateTime = $result->getCreatedDateTime();
                    $lastModifiedDateTime = $result->getLastModifiedDateTime();

                    App::result('file', [
                        'id' => $itemId,
                        'webUrl' => $webUrl,
                        'name' => $name,
                        'size' => $size,
                        'createdDateTime' => $createdDateTime,
                        'lastModifiedDateTime' => $lastModifiedDateTime
                    ]);

                    App::result('success', true);
                } else {
                    throw new \Exception('no personal drive found');
                }
            } catch (ApiException $ex) {
                App::result('error', [
                    'code' => $ex->getResponseStatusCode(),
                    'message' => $ex->getError()->getMessage()
                ]);
            } catch (\Exception $e) {
                App::result('error', $e->getMessage());
            }
            App::contenttype('application/json');
        }, ['get'], true);
    }
}
